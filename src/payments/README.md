# Payments App - –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –∫—É—Ä—Å–æ–≤

## –û–±–∑–æ—Ä

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `payments` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ–ø–ª–∞—Ç—ã –∫—É—Ä—Å–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Pyland —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–≤—É—Ö –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –¥–ª—è –ì—Ä—É–∑–∏–∏: **BOG** –∏ **TBC**.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–æ–¥–µ–ª–∏

#### Payment
–û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö.

**–ü–æ–ª—è:**
- `id` (UUID) - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–ª–∞—Ç–µ–∂–∞
- `user` (FK) - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–æ–≤–µ—Ä—à–∏–≤—à–∏–π –æ–ø–ª–∞—Ç—É (authentication.User)
- `course` (FK) - –û–ø–ª–∞—á–µ–Ω–Ω—ã–π –∫—É—Ä—Å (courses.Course)
- `amount` (Decimal) - –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (–¥–æ 10 –∑–Ω–∞–∫–æ–≤, 2 –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π)
- `currency` (CharField) - –í–∞–ª—é—Ç–∞: USD, GEL, RUB
- `payment_method` (CharField) - –ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã: bog, tbc
- `status` (CharField) - –°—Ç–∞—Ç—É—Å: pending, processing, completed, failed, cancelled, refunded
- `transaction_id` (CharField) - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (nullable)
- `payment_url` (URLField) - URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É (nullable)
- `extra_data` (JSON) - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- `created_at` (DateTime) - –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- `updated_at` (DateTime) - –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–ú–µ—Ç–æ–¥—ã:**
- `mark_as_completed()` - –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–ª–∞—Ç—ë–∂ –∏ –∑–∞–ø–∏—Å–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–∞ –∫—É—Ä—Å —á–µ—Ä–µ–∑ `course.student_enrollments.add(user.student)`
- `mark_as_failed()` - –ü–æ–º–µ—Ç–∏—Ç—å –ø–ª–∞—Ç—ë–∂ –∫–∞–∫ –Ω–µ—É–¥–∞–≤—à–∏–π—Å—è
- `is_successful()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂–∞ (status == 'completed')
- `can_be_refunded()` - –ú–æ–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ (completed –∏ –Ω–µ —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π)

### –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π
- **pending** - –û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **processing** - –í –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **completed** - –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω (—Å—Ç—É–¥–µ–Ω—Ç –∑–∞–ø–∏—Å–∞–Ω –Ω–∞ –∫—É—Ä—Å)
- **failed** - –û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
- **cancelled** - –û—Ç–º–µ–Ω—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- **refunded** - –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

### –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã
- **bog** - BOG - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç USD, GEL, RUB
- **tbc** - TBC - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç USD, GEL, RUB

### –§–æ—Ä–º—ã

#### CheckoutForm
–§–æ—Ä–º–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ checkout.

**–ü–æ–ª—è:**
- `payment_method` (RadioSelect) - –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
- `currency` (Select) - –í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã
- `terms_accepted` (BooleanField) - –°–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- `privacy_accepted` (BooleanField) - –°–æ–≥–ª–∞—Å–∏–µ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- –û–±–∞ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –≤—Å–µ –≤–∞–ª—é—Ç—ã (USD, GEL, RUB)

### Views

#### checkout_view
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.

**URL:** `/ru/payments/checkout/<course_slug>/`
**–ú–µ—Ç–æ–¥:** GET, POST
**–î–æ—Å—Ç—É–ø:** `@login_required`
**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç –∫—É—Ä—Å —á–µ—Ä–µ–∑ `course_slug` (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç status__in=["active", "published"])
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –∑–∞–ø–∏—Å–∞–Ω –ª–∏ —É–∂–µ —Å—Ç—É–¥–µ–Ω—Ç —á–µ—Ä–µ–∑ `course.student_enrollments.filter(user=request.user).exists()`
3. GET: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ñ–æ—Ä–º—É –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã –∏ –≤–∞–ª—é—Ç—ã
4. POST: –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º—É, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ü–µ–Ω—É –∫—É—Ä—Å–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É
5. –°–æ–∑–¥–∞—ë—Ç Payment —Å —Å—Ç–∞—Ç—É—Å–æ–º `pending`
6. –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `payments:processing` —Å payment_id

**–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç—ã:**
```python
EXCHANGE_RATES = {
    'USD': 1.0,   # –ë–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞
    'GEL': 2.8,   # 1 USD = 2.8 GEL
    'RUB': 95.0,  # 1 USD = 95 RUB
}
```

#### payment_success_view
**URL:** `/ru/payments/success/<payment_id>/`
**–ú–µ—Ç–æ–¥:** GET
**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞—Ö–æ–¥–∏—Ç Payment –ø–æ UUID
2. –í—ã–∑—ã–≤–∞–µ—Ç `payment.mark_as_completed()` (–æ–±–Ω–æ–≤–ª—è–µ—Ç status, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞ –∫—É—Ä—Å)
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ"

#### payment_cancel_view
**URL:** `/ru/payments/cancel/<payment_id>/`
**–ú–µ—Ç–æ–¥:** GET
**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞—Ö–æ–¥–∏—Ç Payment –ø–æ UUID
2. –û–±–Ω–æ–≤–ª—è–µ—Ç status –Ω–∞ 'cancelled'
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–º–µ–Ω—ã —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"

## –ö—É—Ä—Å–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏

```python
EXCHANGE_RATES = {
    'USD': 1.0,      # –ë–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞
    'GEL': 2.8,      # 1 USD = 2.8 GEL
    'RUB': 95.0,     # 1 USD = 95 RUB
}
```

## URL Patterns

```python
# payments/urls.py
path('checkout/<slug:course_slug>/', checkout_view, name='checkout')
path('success/<uuid:payment_id>/', payment_success_view, name='success')
path('cancel/<uuid:payment_id>/', payment_cancel_view, name='cancel')
path('processing/<uuid:payment_id>/', payment_processing_view, name='processing')

# Webhooks (TODO - –±—É–¥—É—â–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏):
# path('webhook/bog/', bog_webhook, name='bog_webhook')
# path('webhook/tbc/', tbc_webhook, name='tbc_webhook')
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —à–∞–±–ª–æ–Ω–∞—Ö:**
```django
{% url 'payments:checkout' course_slug=course.slug %}
{% url 'payments:success' payment_id=payment.id %}
```

## Workflow –æ–ø–ª–∞—Ç—ã

```mermaid
graph TD
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫—É—Ä—Å–∞] --> B{–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω?}
    B -->|–ù–µ—Ç| C[Redirect /ru/students/signin/?next=/ru/payments/checkout/slug/]
    B -->|–î–∞| D{–£–∂–µ –∑–∞–ø–∏—Å–∞–Ω?}
    D -->|–î–∞| E[–ü–æ–∫–∞–∑–∞—Ç—å '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ']
    D -->|–ù–µ—Ç| F[–ü–æ–∫–∞–∑–∞—Ç—å '–ö—É–ø–∏—Ç—å –∫—É—Ä—Å']
    F --> G[GET /ru/payments/checkout/slug/]
    G --> H[–í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã + –≤–∞–ª—é—Ç—ã]
    H --> I[POST —Å —Ñ–æ—Ä–º–æ–π CheckoutForm]
    I --> J[–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã]
    J --> K[–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–µ–Ω—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É]
    K --> L[–°–æ–∑–¥–∞–Ω–∏–µ Payment status=pending]
    L --> M[Redirect /ru/payments/processing/uuid/]
    M --> N[–ó–∞–≥—Ä—É–∑–∫–∞... Redirect –∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–º—É —à–ª—é–∑—É]
    N --> O{–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞?}
    O -->|–î–∞| P[/ru/payments/success/uuid/]
    O -->|–ù–µ—Ç| Q[/ru/payments/cancel/uuid/]
    P --> R[mark_as_completed + –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ –∫—É—Ä—Å]
    Q --> S[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ status=cancelled]
```

**–ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫—É—Ä—Å–∞ ‚Üí "üí≥ –ö—É–ø–∏—Ç—å –∫—É—Ä—Å"
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Üí –ï—Å–ª–∏ –Ω–µ—Ç: redirect –Ω–∞ signin
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è ‚Üí –ï—Å–ª–∏ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω: –ø–æ–∫–∞–∑–∞—Ç—å "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
4. Redirect ‚Üí `/ru/payments/checkout/<slug>/`
5. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã: –º–µ—Ç–æ–¥ (BOG/TBC) + –≤–∞–ª—é—Ç–∞ (USD/GEL/RUB) + —Å–æ–≥–ª–∞—Å–∏—è
6. Submit ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
7. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–µ–Ω—ã –∫—É—Ä—Å–∞ —á–µ—Ä–µ–∑ EXCHANGE_RATES
8. –°–æ–∑–¥–∞–Ω–∏–µ Payment (status=pending)
9. Redirect ‚Üí `/ru/payments/processing/<uuid>/` (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏)
10. JavaScript redirect ‚Üí –ü–ª–∞—Ç—ë–∂–Ω—ã–π —à–ª—é–∑ (BOG / TBC)
11. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:
    - Success ‚Üí `/ru/payments/success/<uuid>/` ‚Üí `mark_as_completed()` ‚Üí –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `student_enrollments.add()`
    - Cancel ‚Üí `/ru/payments/cancel/<uuid>/` ‚Üí `status='cancelled'`

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í—Å–µ views –∑–∞—â–∏—â–µ–Ω—ã `@login_required`
- ‚úÖ UUID –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π (–Ω–µ –ø–æ–¥–±–∏—Ä–∞–µ–º—ã–µ ID)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫—É—Ä—Å–∞ (404 –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∑–∞–ø–∏—Å—å: `course.student_enrollments.filter(user=request.user).exists()`
- ‚úÖ CSRF protection (Django —Ñ–æ—Ä–º—ã)
- ‚úÖ –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ (has_add_permission=False, has_change_permission=False)
- ‚úÖ Readonly fields –≤ –∞–¥–º–∏–Ω–∫–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Colored status badges –≤ –∞–¥–º–∏–Ω–∫–µ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
- ‚ö†Ô∏è TODO: Webhook signature verification –¥–ª—è BOG/TBC
- ‚ö†Ô∏è TODO: Rate limiting –¥–ª—è payment endpoints

## Admin –ø–∞–Ω–µ–ª—å

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ –¶–≤–µ—Ç–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–æ–≤ —Å emoji:
  - üü° pending - –ñ—ë–ª—Ç—ã–π
  - üîµ processing - –°–∏–Ω–∏–π
  - üü¢ completed - –ó–µ–ª—ë–Ω—ã–π
  - üî¥ failed - –ö—Ä–∞—Å–Ω—ã–π
  - ‚ö´ cancelled - –°–µ—Ä—ã–π
  - üü£ refunded - –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—É–º–º—ã —Å —Å–∏–º–≤–æ–ª–∞–º–∏ –≤–∞–ª—é—Ç ($, ‚Çæ, ‚ÇΩ)
- ‚úÖ –ò–∫–æ–Ω–∫–∏ –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã (üè¶ BOG, üí≥ TBC)
- ‚úÖ –°—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫—É—Ä—Å –≤ –∞–¥–º–∏–Ω–∫–µ
- ‚úÖ –§–∏–ª—å—Ç—Ä—ã: status, payment_method, currency, created_at
- ‚úÖ –ü–æ–∏—Å–∫: transaction_id, user email, course name
- ‚úÖ –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- ‚úÖ –î–µ–π—Å—Ç–≤–∏–µ "–í–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞" (mark_as_refunded)
- ‚úÖ Readonly –ø–æ–ª—è: id, transaction_id, created_at, updated_at

**–î–æ—Å—Ç—É–ø:**
`/admin/payments/payment/` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π

## Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –®–∞–±–ª–æ–Ω—ã
- **checkout.html** - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (470+ —Å—Ç—Ä–æ–∫ CSS)
  - Grid layout: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—Å–µ (—Å–ª–µ–≤–∞) + —Ñ–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã (—Å–ø—Ä–∞–≤–∞)
  - –ö–∞—Å—Ç–æ–º–Ω—ã–µ radio buttons –¥–ª—è –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã
  - Dropdown –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∞–ª—é—Ç—ã
  - –ß–µ–∫–±–æ–∫—Å—ã —Å–æ–≥–ª–∞—Å–∏—è —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø–æ–ª–∏—Ç–∏–∫–æ–π
  - –†–µ—Å–ø–æ–Ω—Å–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω: 1024px ‚Üí single column, 640px ‚Üí mobile

- **payment_processing.html** - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π spinner
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π redirect –∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–º—É —à–ª—é–∑—É (TODO)

- **payment_success.html** - –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
  - –ó–µ–ª–µ–Ω–∞—è –≥–∞–ª–æ—á–∫–∞ ‚úì
  - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏ –Ω–∞ –∫—É—Ä—Å
  - –ö–Ω–æ–ø–∫–∞ "üöÄ –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ" ‚Üí redirect –∫ –∫—É—Ä—Å—É

- **payment_cancel.html** - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–º–µ–Ω—ã
  - –û—Ä–∞–Ω–∂–µ–≤—ã–π –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫ ‚ö†Ô∏è
  - –ö–Ω–æ–ø–∫–∞ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞" ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫ checkout
  - –ö–Ω–æ–ø–∫–∞ "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å–∞–º"

### –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã

**CSS:** `/static/css/payments/checkout.css` (~470 –ª–∏–Ω–∏–π)
- Grid –∏ Flexbox layouts
- Custom form controls
- –ê–Ω–∏–º–∞—Ü–∏–∏ (@keyframes spin)
- Media queries –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤

**JavaScript:** `/static/js/payments/checkout.js`
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∞–ª—é—Ç—ã
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã
- LocalStorage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –≤–∞–ª—é—Ç—ã
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ converted price –≤ UI

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ course_detail.html

–ö–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫—É—Ä—Å–∞:

```django
{% if user.is_authenticated %}
    {% if user.student in course.student_enrollments.all %}
        <a href="{% url 'students:dashboard' %}" class="btn btn-success">
            üöÄ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
        </a>
    {% else %}
        <a href="{% url 'payments:checkout' course_slug=course.slug %}" class="btn btn-primary">
            üí≥ –ö—É–ø–∏—Ç—å –∫—É—Ä—Å
        </a>
    {% endif %}
{% else %}
    <a href="{% url 'students:signin' %}?next={% url 'payments:checkout' course_slug=course.slug %}" class="btn btn-warning">
        üîê –í–æ–π—Ç–∏ –∏ –∫—É–ø–∏—Ç—å
    </a>
{% endif %}
```

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏

### Course.student_enrollments
**–í–ê–ñ–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `student_enrollments` (–ù–ï `students`!)

```python
# courses/models.py
class Course(models.Model):
    # ... other fields
    students = models.ManyToManyField(
        'authentication.Student',
        related_name='student_enrollments',  # ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ!
        verbose_name='–°—Ç—É–¥–µ–Ω—Ç—ã'
    )
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
course.student_enrollments.add(student)
course.student_enrollments.filter(user=user).exists()

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
course.students.add(student)  # AttributeError!
```

### Student Profile
–ò–∑ `authentication/models.py`:
```python
student = request.user.student  # OneToOne relationship
course.student_enrollments.add(student)
```

### –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
```
POST   /api/payments/initiate
{
  "course_id": "uuid",
  "payment_method": "card"
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```
GET    /api/payments/{id}
```

### Webhook –¥–ª—è —à–ª—é–∑–æ–≤
```
POST   /api/payments/webhook
```

### –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
```
GET    /api/payments/history
```

### –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
```
POST   /api/payments/{id}/refund
```

## Views

### purchase_view
–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫—É–ø–∫–∏ –∫—É—Ä—Å–∞:
- GET: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã
- POST: –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–ª–∞—Ç–µ–∂
- –¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

### 1. –ò–Ω–∏—Ü–∏–∞—Ü–∏—è
```
–°—Ç—É–¥–µ–Ω—Ç ‚Üí –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫—É—Ä—Å–∞ ‚Üí –ö–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å" ‚Üí purchase_view
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞
```
purchase_view ‚Üí Payment Gateway API ‚Üí Redirect –∫ —à–ª—é–∑—É
```

### 3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```
Gateway ‚Üí Webhook ‚Üí Update Payment status ‚Üí Enroll student
```

### 4. –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ
```
Payment.status = 'completed' ‚Üí –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ Course.students
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —à–ª—é–∑–∞–º–∏

### Stripe (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
```python
import stripe
stripe.api_key = settings.STRIPE_SECRET_KEY
intent = stripe.PaymentIntent.create(...)
```

### PayPal (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
```python
from paypalrestsdk import Payment
payment = Payment({...})
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- ‚ùå –ù–ï —Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç
- ‚úÖ –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ transaction_id
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –®–∏—Ñ—Ä—É–µ–º sensitive –¥–∞–Ω–Ω—ã–µ –≤ extra_data

### –í–∞–ª–∏–¥–∞—Ü–∏—è webhook
```python
def verify_webhook_signature(payload, signature):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ —à–ª—é–∑–∞
    ...
```

## Admin –ø–∞–Ω–µ–ª—å

–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É, –º–µ—Ç–æ–¥—É, –¥–∞—Ç–µ
- –¶–≤–µ—Ç–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–æ–≤
- –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV/Excel
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–ª–∞—Ç–µ–∂–∞–º
- –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ (–∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ API)

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:
- Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- Webhook –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã (Stripe)
```
4242 4242 4242 4242 - Success
4000 0000 0000 0002 - Decline
4000 0000 0000 9995 - Insufficient funds
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
pytest payments/tests/ -v
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –æ–ø–ª–∞—Ç
- –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤:
- `payments.log`
- Sentry –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- Admin panel –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

- **courses** - —Å–≤—è–∑—å –ø–ª–∞—Ç–µ–∂–∞ —Å –∫—É—Ä—Å–æ–º
- **students** - –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- **notifications** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ
- **certificates** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–í `settings.py`:
```python
# Payment settings
STRIPE_PUBLIC_KEY = env('STRIPE_PUBLIC_KEY')
STRIPE_SECRET_KEY = env('STRIPE_SECRET_KEY')
STRIPE_WEBHOOK_SECRET = env('STRIPE_WEBHOOK_SECRET')

PAYPAL_CLIENT_ID = env('PAYPAL_CLIENT_ID')
PAYPAL_SECRET = env('PAYPAL_SECRET')

DEFAULT_CURRENCY = 'GEL'
```

## –ê–≤—Ç–æ—Ä—ã

Pyland Team, 2025
