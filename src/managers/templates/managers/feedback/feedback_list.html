{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Обратная связь" %} - Pyland{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/managers/dashboard.css' %}?v=20260204-actions">
{% endblock %}

{% block header %}
{% include 'shared/_header.html' with show_dashboard_button=True %}
{% endblock %}

{% block content %}
<!-- Sidebar overlay -->
<div class="sidebar-overlay"></div>

<div class="dashboard-layout">
    <aside class="dashboard-sidebar">
        {% include 'managers/_sidebar_nav.html' with active_page='feedback' %}
    </aside>

    <main class="dashboard-main">
        <header class="dashboard-header">
            <div>
                <h1 class="dashboard-title">{% trans "Обратная связь" %}</h1>
                <div class="dashboard-breadcrumb">
                    <a href="{% url 'managers:dashboard' request.user.manager.id %}">{% trans "Главная" %}</a>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="m9 18 6-6-6-6"/>
                    </svg>
                    <span>{% trans "Обратная связь" %}</span>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="view-toggle-btn active" data-view="grid" title="{% trans 'Сетка' %}">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                    </svg>
                </button>
                <button class="view-toggle-btn" data-view="list" title="{% trans 'Список' %}">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Filters Section with Statistics -->
        <div class="filters-section-compact">
            <!-- Status Filter with Counts -->
            <div class="filter-group-inline">
                <label class="filter-label-inline">{% trans "Статус:" %}</label>
                <div class="filter-buttons-inline">
                    <a href="{% url 'managers:feedback_list' request.user.manager.id %}"
                       class="filter-btn {% if not request.GET.is_processed %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Все" %}</span>
                        <span class="filter-btn-count">{{ total_count|default:0 }}</span>
                    </a>
                    <a href="?is_processed=false"
                       class="filter-btn {% if request.GET.is_processed == 'false' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Ожидают" %}</span>
                        <span class="filter-btn-count">{{ pending_count|default:0 }}</span>
                    </a>
                    <a href="?is_processed=true"
                       class="filter-btn {% if request.GET.is_processed == 'true' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Обработано" %}</span>
                        <span class="filter-btn-count">{{ processed_count|default:0 }}</span>
                    </a>
                </div>
            </div>

            <!-- Topic Filter -->
            <div class="filter-group-inline">
                <label class="filter-label-inline">{% trans "Тема:" %}</label>
                <div class="filter-buttons-inline">
                    <a href="{% url 'managers:feedback_list' request.user.manager.id %}{% if request.GET.is_processed %}?is_processed={{ request.GET.is_processed }}{% endif %}"
                       class="filter-btn {% if not request.GET.topic %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Все темы" %}</span>
                    </a>
                    <a href="?topic=courses{% if request.GET.is_processed %}&is_processed={{ request.GET.is_processed }}{% endif %}"
                       class="filter-btn {% if request.GET.topic == 'courses' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Курсы" %}</span>
                    </a>
                    <a href="?topic=career{% if request.GET.is_processed %}&is_processed={{ request.GET.is_processed }}{% endif %}"
                       class="filter-btn {% if request.GET.topic == 'career' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Карьера" %}</span>
                    </a>
                    <a href="?topic=technical{% if request.GET.is_processed %}&is_processed={{ request.GET.is_processed }}{% endif %}"
                       class="filter-btn {% if request.GET.topic == 'technical' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Техподдержка" %}</span>
                    </a>
                    <a href="?topic=partnership{% if request.GET.is_processed %}&is_processed={{ request.GET.is_processed }}{% endif %}"
                       class="filter-btn {% if request.GET.topic == 'partnership' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Сотрудничество" %}</span>
                    </a>
                    <a href="?topic=other{% if request.GET.is_processed %}&is_processed={{ request.GET.is_processed }}{% endif %}"
                       class="filter-btn {% if request.GET.topic == 'other' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Другое" %}</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Feedback List -->
        {% if page_obj %}
        <div class="reviews-container" data-view="grid">
            {% for feedback in page_obj %}
            <div class="review-card">
                <div class="review-card-header">
                    <div class="review-status-badge {% if feedback.is_processed %}success{% else %}warning{% endif %}">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            {% if feedback.is_processed %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            {% else %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            {% endif %}
                        </svg>
                    </div>
                    <div class="review-card-status">
                        {% if feedback.is_processed %}
                            <span class="badge badge-success">{% trans "Обработано" %}</span>
                        {% else %}
                            <span class="badge badge-warning">{% trans "Ожидает" %}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="review-card-body">
                    <h4 class="review-lesson-name">{{ feedback.get_topic_display|default:"Обращение" }}</h4>
                    <p class="review-course-info">
                        <span class="review-student">{{ feedback.first_name }}</span>
                        <span class="review-separator">•</span>
                        <span class="review-course">{{ feedback.email }}</span>
                    </p>

                    {% if feedback.message %}
                    <div class="review-comments-box">
                        <p class="review-comments-text">{{ feedback.message|truncatewords:20 }}</p>
                    </div>
                    {% endif %}
                </div>

                <div class="review-card-footer">
                    <div class="review-meta">
                        <span class="review-date">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            {{ feedback.registered_at|date:"d M Y, H:i" }}
                        </span>
                        {% if feedback.phone_number %}
                        <span class="review-time">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            {{ feedback.phone_number }}
                        </span>
                        {% endif %}
                    </div>
                    <a href="{% url 'managers:feedback_detail' request.user.manager.id feedback.id %}" class="btn btn-secondary btn-sm">
                        {% trans "Подробнее" %}
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination-wrapper">
            <div class="pagination-info">
                {% trans "Показано" %} {{ page_obj|length }} {% trans "из" %} {{ page_obj.paginator.count }} {% trans "обращений" %}
            </div>
            <div class="pagination-controls">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="pagination-btn" title="{% trans 'Первая страница' %}">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                        </svg>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="pagination-btn" title="{% trans 'Предыдущая' %}">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                {% else %}
                    <span class="pagination-btn disabled">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                        </svg>
                    </span>
                    <span class="pagination-btn disabled">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </span>
                {% endif %}

                <span class="pagination-current">
                    {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="pagination-btn" title="{% trans 'Следующая' %}">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="pagination-btn" title="{% trans 'Последняя страница' %}">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                        </svg>
                    </a>
                {% else %}
                    <span class="pagination-btn disabled">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </span>
                    <span class="pagination-btn disabled">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                        </svg>
                    </span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="empty-state" style="margin-top: 3rem;">
            <div class="empty-icon">
                <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
            </div>
            <h3 class="empty-title">{% trans "Обращений не найдено" %}</h3>
            <p class="empty-message">{% trans "Попробуйте изменить параметры фильтров или проверьте позже" %}</p>
        </div>
        {% endif %}
    </main>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/managers/dashboard-mobile.js' %}?v=20260204-fixes"></script>
<script src="{% static 'js/managers/dashboard.js' %}"></script>
{% endblock %}
