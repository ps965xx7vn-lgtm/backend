{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Платежи" %} - Pyland{% endblock %}

{% block header %}
{% include 'shared/_header.html' with show_dashboard_button=True %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/managers/dashboard.css' %}?v=20260205-payments">
{% endblock %}

{% block content %}
<div class="sidebar-overlay"></div>

<div class="dashboard-layout">
    <aside class="dashboard-sidebar">
        {% include 'managers/_sidebar_nav.html' with active_page='payments' %}
    </aside>

    <main class="dashboard-main">
        <header class="dashboard-header">
            <div>
                <h1 class="dashboard-title">{% trans "Управление платежами" %}</h1>
                <div class="dashboard-breadcrumb">
                    <a href="{% url 'managers:dashboard' request.user.manager.id %}">{% trans "Главная" %}</a>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="m9 18 6-6-6-6"/>
                    </svg>
                    <span>{% trans "Платежи" %}</span>
                </div>
            </div>
            <div class="dashboard-actions">
                <a href="{% url 'managers:payments_reports' request.user.manager.id %}" class="btn btn-secondary">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    {% trans "Отчеты" %}
                </a>
                <a href="{% url 'managers:payments_export' request.user.manager.id %}" class="btn btn-primary">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    {% trans "Экспорт CSV" %}
                </a>
            </div>
        </header>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon success">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ stats.total_revenue|floatformat:2|default:"0" }} ₽</h3>
                <p class="stat-label">{% trans "Общий доход" %}</p>
            </div>

            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ stats.completed_count|default:"0" }}</h3>
                <p class="stat-label">{% trans "Завершено" %}</p>
            </div>

            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon warning">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ stats.processing_count|default:"0" }}</h3>
                <p class="stat-label">{% trans "Обрабатывается" %}</p>
            </div>

            <div class="stat-card danger">
                <div class="stat-header">
                    <div class="stat-icon danger">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ stats.failed_count|default:"0" }}</h3>
                <p class="stat-label">{% trans "Неудачные" %}</p>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section-compact">
            <!-- Status Filter -->
            <div class="filter-group-inline">
                <label class="filter-label-inline">{% trans "Статус:" %}</label>
                <div class="filter-buttons-inline">
                    <a href="{% url 'managers:payments_list' request.user.manager.id %}"
                       class="filter-btn {% if not request.GET.status %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Все статусы" %}</span>
                    </a>
                    <a href="?status=completed"
                       class="filter-btn {% if request.GET.status == 'completed' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Завершено" %}</span>
                    </a>
                    <a href="?status=pending"
                       class="filter-btn {% if request.GET.status == 'pending' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Ожидает" %}</span>
                    </a>
                    <a href="?status=processing"
                       class="filter-btn {% if request.GET.status == 'processing' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Обрабатывается" %}</span>
                    </a>
                    <a href="?status=failed"
                       class="filter-btn {% if request.GET.status == 'failed' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Неудачно" %}</span>
                    </a>
                    <a href="?status=refunded"
                       class="filter-btn {% if request.GET.status == 'refunded' %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Возврат" %}</span>
                    </a>
                </div>
            </div>

            <!-- Payment Method Filter -->
            <div class="filter-group-inline">
                <label class="filter-label-inline">{% trans "Метод оплаты:" %}</label>
                <div class="filter-buttons-inline">
                    <a href="{% url 'managers:payments_list' request.user.manager.id %}{% if request.GET.status %}?status={{ request.GET.status }}{% endif %}"
                       class="filter-btn {% if not request.GET.payment_method %}active{% endif %}">
                        <span class="filter-btn-text">{% trans "Все методы" %}</span>
                    </a>
                    <a href="?payment_method=cloudpayments{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
                       class="filter-btn {% if request.GET.payment_method == 'cloudpayments' %}active{% endif %}">
                        <span class="filter-btn-text">CloudPayments (РФ)</span>
                    </a>
                    <a href="?payment_method=tbc_georgia{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
                       class="filter-btn {% if request.GET.payment_method == 'tbc_georgia' %}active{% endif %}">
                        <span class="filter-btn-text">TBC Bank (Грузия)</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Payments Table -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">
                    {% trans "Список платежей" %}
                    {% if page_obj %}
                        <span class="chart-subtitle">({% trans "показано" %} {{ page_obj|length }} {% trans "из" %} {{ total_count }})</span>
                    {% endif %}
                </h3>
            </div>
            <div class="chart-content">
                {% if page_obj %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>{% trans "Дата" %}</th>
                                    <th>{% trans "Пользователь" %}</th>
                                    <th>{% trans "Курс" %}</th>
                                    <th>{% trans "Сумма" %}</th>
                                    <th>{% trans "Статус" %}</th>
                                    <th>{% trans "Метод" %}</th>
                                    <th>{% trans "Действия" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in page_obj %}
                                <tr>
                                    <td><strong>{{ payment.id }}</strong></td>
                                    <td>{{ payment.created_at|date:"d.m.Y H:i" }}</td>
                                    <td>
                                        <div>{{ payment.user.get_full_name }}</div>
                                        <div style="font-size: 0.85em; opacity: 0.7;">{{ payment.user.email }}</div>
                                    </td>
                                    <td>{{ payment.course.name|default:"-" }}</td>
                                    <td><strong>{{ payment.amount }} {{ payment.currency }}</strong></td>
                                    <td>
                                        {% if payment.status == 'completed' %}
                                            <span class="badge badge-success">{% trans "Завершен" %}</span>
                                        {% elif payment.status == 'pending' %}
                                            <span class="badge badge-warning">{% trans "Ожидание" %}</span>
                                        {% elif payment.status == 'failed' %}
                                            <span class="badge badge-danger">{% trans "Ошибка" %}</span>
                                        {% elif payment.status == 'refunded' %}
                                            <span class="badge badge-info">{% trans "Возвращен" %}</span>
                                        {% else %}
                                            <span class="badge">{{ payment.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ payment.get_payment_method_display }}</td>
                                    <td>
                                        <a href="{% url 'managers:payment_detail' request.user.manager.id payment.id %}" class="btn btn-sm btn-secondary">
                                            {% trans "Просмотр" %}
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <div class="pagination-wrapper">
                        <div class="pagination-info">
                            <span class="pagination-text">
                                {% blocktrans with current=page_obj.number total=page_obj.paginator.num_pages count=total_count %}
                                Страница {{ current }} из {{ total }} • Всего: {{ count }}
                                {% endblocktrans %}
                            </span>
                        </div>
                        <div class="pagination-controls">
                            {% if page_obj.has_previous %}
                                <a href="?page=1{{ filter_form.query_string }}" class="pagination-btn">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                                    </svg>
                                </a>
                                <a href="?page={{ page_obj.previous_page_number }}{{ filter_form.query_string }}" class="pagination-btn">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                    </svg>
                                </a>
                            {% else %}
                                <span class="pagination-btn disabled">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                                    </svg>
                                </span>
                                <span class="pagination-btn disabled">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                    </svg>
                                </span>
                            {% endif %}

                            <span class="pagination-current">
                                {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                            </span>

                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}{{ filter_form.query_string }}" class="pagination-btn">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </a>
                                <a href="?page={{ page_obj.paginator.num_pages }}{{ filter_form.query_string }}" class="pagination-btn">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                                    </svg>
                                </a>
                            {% else %}
                                <span class="pagination-btn disabled">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </span>
                                <span class="pagination-btn disabled">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                                    </svg>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 class="empty-title">{% trans "Платежей не найдено" %}</h3>
                        <p class="empty-message">{% trans "Попробуйте изменить параметры фильтров" %}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/managers/dashboard-mobile.js' %}?v=20260205-payments"></script>
{% endblock %}
