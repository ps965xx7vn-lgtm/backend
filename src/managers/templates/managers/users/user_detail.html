{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{{ viewed_user.get_full_name|default:viewed_user.email }} - Pyland{% endblock %}

{% block header %}
{% include 'shared/_header.html' with show_dashboard_button=True %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/managers/dashboard.css' %}?v=20260205-user-profile">
{% endblock %}

{% block content %}
<!-- Sidebar overlay -->
<div class="sidebar-overlay"></div>

<div class="dashboard-layout">
    <aside class="dashboard-sidebar">
        {% include 'managers/_sidebar_nav.html' with active_page='users' %}
    </aside>

    <main class="dashboard-main">
        <header class="dashboard-header">
            <div>
                <h1 class="dashboard-title">{% trans "Профиль пользователя" %}</h1>
                <div class="dashboard-breadcrumb">
                    <a href="{% url 'managers:dashboard' request.user.manager.id %}">{% trans "Главная" %}</a>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="m9 18 6-6-6-6"/>
                    </svg>
                    <a href="{% url 'managers:users_list' request.user.manager.id %}">{% trans "Пользователи" %}</a>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="m9 18 6-6-6-6"/>
                    </svg>
                    <span>{{ viewed_user.get_full_name|default:user.email }}</span>
                </div>
            </div>
            <div>
                <a href="{% url 'managers:users_list' request.user.manager.id %}" class="btn btn-secondary">
                    ← {% trans "Назад" %}
                </a>
            </div>
        </header>

        <!-- User Profile Card -->
        <div class="feedback-detail-card">
            <div class="feedback-card-header">
                <div class="user-profile-avatar">
                    {% if viewed_user.student and user.student.avatar %}
                        <img src="{{ viewed_user.student.avatar.url }}" alt="{{ viewed_user.get_full_name }}" class="user-avatar-large">
                    {% else %}
                        <div class="user-avatar-placeholder-large">
                            {{ viewed_user.first_name|first|default:"U"|upper }}{{ viewed_user.last_name|first|default:""|upper }}
                        </div>
                    {% endif %}
                </div>
                <div class="feedback-header-info">
                    <h2 class="feedback-subject">{{ viewed_user.get_full_name|default:user.email }}</h2>
                    <div class="feedback-meta">
                        <span class="feedback-email">{{ viewed_user.email }}</span>
                        {% if viewed_user.role %}
                            <span class="feedback-separator">•</span>
                            <span class="badge badge-{% if viewed_user.role.name == 'student' %}info{% elif user.role.name == 'mentor' %}primary{% elif user.role.name == 'reviewer' %}warning{% elif user.role.name == 'manager' %}success{% else %}secondary{% endif %}">
                                {{ viewed_user.role.get_name_display }}
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="feedback-status-label">
                    {% if viewed_user.is_active %}
                        <span class="badge badge-success">{% trans "Активен" %}</span>
                    {% else %}
                        <span class="badge badge-danger">{% trans "Неактивен" %}</span>
                    {% endif %}
                </div>
            </div>

            <div class="feedback-card-body">
                <!-- Contact Information Grid -->
                <div class="feedback-contact-grid">
                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            {% trans "Email" %}
                        </div>
                        <div class="feedback-contact-value">
                            <a href="mailto:{{ viewed_user.email }}">{{ viewed_user.email }}</a>
                        </div>
                    </div>

                    {% if viewed_user.student and user.student.phone %}
                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            {% trans "Телефон" %}
                        </div>
                        <div class="feedback-contact-value">
                            <a href="tel:{{ viewed_user.student.phone }}">{{ viewed_user.student.phone }}</a>
                        </div>
                    </div>
                    {% endif %}

                    {% if viewed_user.student and user.student.country %}
                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {% trans "Страна" %}
                        </div>
                        <div class="feedback-contact-value">{{ viewed_user.student.country.name }}</div>
                    </div>
                    {% endif %}

                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            {% trans "Дата регистрации" %}
                        </div>
                        <div class="feedback-contact-value">{{ viewed_user.date_joined|date:"d.m.Y H:i" }}</div>
                    </div>

                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {% trans "Последний вход" %}
                        </div>
                        <div class="feedback-contact-value">
                            {% if viewed_user.last_login %}
                                {{ viewed_user.last_login|date:"d.m.Y H:i" }}
                            {% else %}
                                <span class="text-muted">{% trans "Никогда" %}</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {% trans "Подтверждение email" %}
                        </div>
                        <div class="feedback-contact-value">
                            {% if viewed_user.email_is_verified %}
                                <span class="badge badge-success">{% trans "Подтвержден" %}</span>
                            {% else %}
                                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                    <span class="badge badge-warning">{% trans "Не подтвержден" %}</span>
                                    <form method="post" style="margin: 0;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="verify_email">
                                        <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Подтвердить email для этого пользователя?')">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            {% trans "Подтвердить" %}
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if viewed_user.student %}
                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            {% trans "Имя" %}
                        </div>
                        <div class="feedback-contact-value">
                            {{ viewed_user.first_name|default:"—" }} {{ viewed_user.last_name|default:"" }}
                        </div>
                    </div>

                    {% if viewed_user.student.country %}
                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {% trans "Страна" %}
                        </div>
                        <div class="feedback-contact-value">
                            {{ viewed_user.student.country.name }}
                        </div>
                    </div>
                    {% endif %}

                    {% if viewed_user.student.birthdate %}
                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            {% trans "Дата рождения" %}
                        </div>
                        <div class="feedback-contact-value">
                            {{ viewed_user.student.birthdate|date:"d.m.Y" }}
                        </div>
                    </div>
                    {% endif %}

                    {% if viewed_user.student.gender %}
                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            {% trans "Пол" %}
                        </div>
                        <div class="feedback-contact-value">
                            {{ viewed_user.student.get_gender_display }}
                        </div>
                    </div>
                    {% endif %}

                    {% if viewed_user.student.education_level %}
                    <div class="feedback-contact-item">
                        <div class="feedback-contact-label">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                            </svg>
                            {% trans "Образование" %}
                        </div>
                        <div class="feedback-contact-value">
                            {{ viewed_user.student.get_education_level_display }}
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>

                <!-- Notification Settings -->
                {% if viewed_user.student %}
                <div style="margin-top: 2rem;">
                    <h3 class="feedback-section-title">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        {% trans "Настройки уведомлений" %}
                    </h3>
                    <div class="feedback-contact-grid">
                        <div class="feedback-contact-item">
                            <div class="feedback-contact-label">{% trans "Email уведомления" %}</div>
                            <div class="feedback-contact-value">
                                <span class="badge badge-{% if viewed_user.student.email_notifications %}success{% else %}secondary{% endif %}">
                                    {% if viewed_user.student.email_notifications %}{% trans "Включены" %}{% else %}{% trans "Выключены" %}{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="feedback-contact-item">
                            <div class="feedback-contact-label">{% trans "SMS уведомления" %}</div>
                            <div class="feedback-contact-value">
                                <span class="badge badge-{% if viewed_user.student.sms_notifications %}success{% else %}secondary{% endif %}">
                                    {% if viewed_user.student.sms_notifications %}{% trans "Включены" %}{% else %}{% trans "Выключены" %}{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Privacy Settings -->
                <div style="margin-top: 2rem;">
                    <h3 class="feedback-section-title">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                        {% trans "Настройки конфиденциальности" %}
                    </h3>
                    <div class="feedback-contact-grid">
                        <div class="feedback-contact-item">
                            <div class="feedback-contact-label">{% trans "Профиль публичный" %}</div>
                            <div class="feedback-contact-value">
                                <span class="badge badge-{% if viewed_user.student.is_profile_public %}success{% else %}secondary{% endif %}">
                                    {% if viewed_user.student.is_profile_public %}{% trans "Да" %}{% else %}{% trans "Нет" %}{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="feedback-contact-item">
                            <div class="feedback-contact-label">{% trans "Показывать прогресс" %}</div>
                            <div class="feedback-contact-value">
                                <span class="badge badge-{% if viewed_user.student.show_progress %}success{% else %}secondary{% endif %}">
                                    {% if viewed_user.student.show_progress %}{% trans "Да" %}{% else %}{% trans "Нет" %}{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if viewed_user.student and user.student.bio %}
                <!-- Bio Section -->
                <div class="feedback-message-box" style="margin-top: 2rem;">
                    <h3 class="feedback-section-title">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        {% trans "О себе" %}
                    </h3>
                    <div class="feedback-message-content">{{ viewed_user.student.bio }}</div>
                </div>
                {% endif %}

                <!-- Manager Notes Section -->
                <div class="feedback-admin-notes" style="margin-top: 2rem;">
                    <h3>
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        {% trans "Комментарии менеджера" %}
                    </h3>

                    <!-- Add Note Form -->
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_note">
                        <textarea
                            name="note"
                            placeholder="{% trans 'Добавьте комментарий о пользователе...' %}"
                        ></textarea>
                        <p class="feedback-admin-notes-help">{% trans "Внутренние заметки для менеджеров" %}</p>
                        <button type="submit" class="btn btn-primary">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            {% trans "Добавить комментарий" %}
                        </button>
                    </form>

                    <!-- Notes List -->
                    {% if manager_notes %}
                    <div class="notes-list" style="margin-top: 1.5rem;">
                        {% for note in manager_notes %}
                        <div class="feedback-message-box" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                                        {{ note.manager.first_name|first|default:note.manager.email|first|upper }}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">{{ note.manager.get_full_name|default:note.manager.email }}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.75rem;">
                                            {{ note.created_at|date:"d.m.Y H:i" }}
                                        </div>
                                    </div>
                                </div>
                                {% if note.created_at != note.updated_at %}
                                <span class="badge badge-info" style="font-size: 0.75rem;">{% trans "Изменено" %}</span>
                                {% endif %}
                            </div>
                            <div class="feedback-message-content">{{ note.note }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="feedback-admin-notes-help" style="margin-top: 1rem; text-align: center;">{% trans "Комментариев пока нет" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Activity Statistics -->
        {% if viewed_user.role and viewed_user.role.name == 'student' %}
        <div class="stats-grid" style="margin-top: 2rem;">
            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ enrolled_courses|default:"0" }}</h3>
                <p class="stat-label">{% trans "Записано на курсы" %}</p>
            </div>

            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon success">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ completed_steps|default:"0" }}</h3>
                <p class="stat-label">{% trans "Завершено шагов" %}</p>
            </div>

            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon warning">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ pending_reviews|default:"0" }}</h3>
                <p class="stat-label">{% trans "Ожидают проверки" %}</p>
            </div>
        </div>

        <!-- Enrollments Table -->
        {% if enrollments %}
        <div class="data-table-wrapper" style="margin-top: 2rem;">
            <h3 class="feedback-section-title" style="padding: 0 0 1rem 0;">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                {% trans "Активные курсы" %}
            </h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>{% trans "Курс" %}</th>
                        <th>{% trans "Прогресс" %}</th>
                        <th>{% trans "Дата записи" %}</th>
                        <th>{% trans "Статус" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for enrollment in enrollments %}
                    <tr>
                        <td>
                            <div class="course-name">{{ enrollment.course.name }}</div>
                        </td>
                        <td>
                            <div class="progress-bar-container">
                                <div class="progress-fill" style="width: {{ enrollment.progress }}%;"></div>
                            </div>
                            <span class="progress-text">{{ enrollment.progress|floatformat:0 }}%</span>
                        </td>
                        <td>{{ viewed_user.date_joined|date:"d.m.Y" }}</td>
                        <td>
                            {% if enrollment.progress == 100 %}
                                {% if enrollment.certificate %}
                                    <span class="badge badge-success">{% trans "Завершен" %}</span>
                                    <a href="{% url 'certificates:download' enrollment.certificate.verification_code %}"
                                       class="btn btn-sm btn-primary"
                                       style="margin-left: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem;"
                                       title="{% trans 'Скачать сертификат' %}">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                        {% trans "Сертификат" %}
                                    </a>
                                {% else %}
                                    <span class="badge badge-warning">{% trans "Сертификат генерируется" %}</span>
                                {% endif %}
                            {% else %}
                                <span class="badge badge-info">{% trans "В процессе" %}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        {% endif %}

        <!-- Reviewer Statistics -->
        {% if viewed_user.role and user.role.name == 'reviewer' %}
        <div class="stats-grid" style="margin-top: 2rem;">
            <div class="stat-card info">
                <div class="stat-header">
                    <div class="stat-icon info">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ total_reviews|default:"0" }}</h3>
                <p class="stat-label">{% trans "Всего проверок" %}</p>
            </div>

            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon success">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ approved_reviews|default:"0" }}</h3>
                <p class="stat-label">{% trans "Одобрено" %}</p>
            </div>

            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon warning">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <h3 class="stat-value">{{ pending_reviews|default:"0" }}</h3>
                <p class="stat-label">{% trans "В ожидании" %}</p>
            </div>
        </div>
        {% endif %}

        <!-- Payment Statistics -->
        {% if recent_payments %}
        <div class="data-table-wrapper" style="margin-top: 2rem;">
            <h3 class="feedback-section-title" style="padding: 0 0 1rem 0;">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                </svg>
                {% trans "История платежей" %} ({% trans "последние 5" %})
            </h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>{% trans "Курс" %}</th>
                        <th>{% trans "Сумма" %}</th>
                        <th>{% trans "Дата" %}</th>
                        <th>{% trans "Статус" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in recent_payments %}
                    <tr>
                        <td>{{ payment.course.name }}</td>
                        <td>{{ payment.amount|floatformat:2 }} ₽</td>
                        <td>{{ payment.created_at|date:"d.m.Y H:i" }}</td>
                        <td>
                            <span class="badge badge-{% if payment.status == 'completed' %}success{% elif payment.status == 'pending' %}warning{% elif payment.status == 'failed' %}danger{% else %}secondary{% endif %}">
                                {{ payment.get_status_display }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if total_spent %}
            <div style="margin-top: 1rem; text-align: right; font-size: 1rem; font-weight: 600;">
                {% trans "Всего потрачено" %}: <span style="color: #10b981;">{{ total_spent|floatformat:2 }} ₽</span>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </main>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/managers/dashboard-mobile.js' %}?v=20260204-fixes"></script>
<script src="{% static 'js/managers/dashboard.js' %}"></script>
{% endblock %}
